<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>KG Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link href=https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <!-- FontAwesome -->
    <script src="https://kit.fontawesome.com/a5c7d26532.js" crossorigin="anonymous"></script>

    <!-- XP.css -->
    <link id="themeCSS" rel="stylesheet" href="https://unpkg.com/7.css">
    <style>

    </style>
    <script>
        // XMLコントロール
        function getXML(dataPath, f) {
            const request = new XMLHttpRequest(); // HTTPでファイルを読み込む
            request.open('GET', dataPath, true); // csvのパスを指定
            request.send();
            request.addEventListener('load', (event) => { // ロードさせ実行
                const response = event.target.responseText; // 受け取ったテキストを返す
                f(response);  // コールバック関数
            });
        }

        // CSV to array
        // http://kentayamamoto.github.io/CSV-parse/
        function CSV2array(strData, strDelimiter) {
            strDelimiter = (strDelimiter || ",");
            var objPattern = new RegExp(
                (
                    "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
                    "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
                    "([^\"\\" + strDelimiter + "\\r\\n]*))"
                ),
                "gi"
            );
            var arrData = [[]];
            var arrMatches = null;
            while (arrMatches = objPattern.exec(strData)) {
                var strMatchedDelimiter = arrMatches[1];
                if (
                    strMatchedDelimiter.length &&
                    (strMatchedDelimiter != strDelimiter)
                ) {
                    arrData.push([]);
                }
                if (arrMatches[2]) {
                    var strMatchedValue = arrMatches[2].replace(
                        new RegExp("\"\"", "g"),
                        "\""
                    );
                } else {
                    var strMatchedValue = arrMatches[3];
                }
                arrData[arrData.length - 1].push(strMatchedValue);
            }
            return (arrData);
        }

        // CSV to json
        /*  <変換精度が悪い>
            原因は、
            テキストブロック内のカンマを区切りに使わない　" *** , *** "
            この際、
            テキストブロック内のダブルクォーテーションを適切に処理する
            いろいろ面倒だから、
            http://kentayamamoto.github.io/CSV-parse/
            を実装する
        */
        function CSV2json(csv) {
            let json = [];
            // 1行目から「項目名」の配列を生成する
            let data = CSV2array(csv,",");
            let key = data[0];
            // 各行処理
            for (let i = 1; i < data.length; i++) {
                let row = new Object();
                for (let j = 0; j < key.length; j++) {
                    row[key[j]] = data[i][j];
                }
                json.push(row);
            }
            return json;
        }

        // tabコントロール
        // https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Roles/Tab_Role
        window.addEventListener("DOMContentLoaded", () => {
            const tabs = document.querySelectorAll('[role="tab"]');
            const tabList = document.querySelector('[role="tablist"]');

            // Add a click event handler to each tab
            tabs.forEach(tab => {
                tab.addEventListener("click", changeTabs);
            });

            // Enable arrow navigation between tabs in the tab list
            let tabFocus = 0;

            tabList.addEventListener("keydown", e => {
                // Move right
                if (e.keyCode === 39 || e.keyCode === 37) {
                    tabs[tabFocus].setAttribute("tabindex", -1);
                    if (e.keyCode === 39) {
                        tabFocus++;
                        // If we're at the end, go to the start
                        if (tabFocus >= tabs.length) {
                            tabFocus = 0;
                        }
                        // Move left
                    } else if (e.keyCode === 37) {
                        tabFocus--;
                        // If we're at the start, move to the end
                        if (tabFocus < 0) {
                            tabFocus = tabs.length - 1;
                        }
                    }

                    tabs[tabFocus].setAttribute("tabindex", 0);
                    tabs[tabFocus].focus();
                }
            });
        });
        function changeTabs(e) {
            const target = e.target;
            const parent = target.parentNode;
            const grandparent = parent.parentNode;

            // Remove all current selected tabs
            parent
                .querySelectorAll('[aria-selected="true"]')
                .forEach(t => t.setAttribute("aria-selected", false));

            // Set this tab as selected
            target.setAttribute("aria-selected", true);

            // Hide all tab panels
            grandparent
                .querySelectorAll('[role="tabpanel"]')
                .forEach(p => p.setAttribute("hidden", true));

            // Show the selected panel
            grandparent.parentNode
                .querySelector(`#${target.getAttribute("aria-controls")}`)
                .removeAttribute("hidden");
        }
    </script>
</head>

<body>

    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 px-3" href="#">KG Dashboard</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <ul class="navbar-nav px-3">
            <li class="nav-item text-nowrap">
                <a class="nav-link" href="#">サインアウト</a>
            </li>
        </ul>
    </header>
    <div class="container-fluid">
        <div class="row">
            <nav class="d-none d-md-block col-3 col-lg-2">qq</nav>
            <main class="col row px-2 g-3">
                <div class="col-6" style="background:#888">ew</div>
                <div class="col-6" style="background:#888">ew</div>
                <div class="col-6" style="background:#888">ew</div>

                <div class="col-12 col-md-6">
                    <div class="window">
                        <div class="title-bar">
                            <div class="title-bar-text">Settings</div>
                            <div class="title-bar-controls">
                                <button aria-label="Minimize"></button>
                                <button aria-label="Maximize"></button>
                                <button aria-label="Close"></button>
                            </div>
                        </div>
                        <div class="window-body">
                            <div class="tab">
                                <menu role="tablist">
                                    <button role="tab" aria-selected="true"
                                        aria-controls="settings_theme">Theme</button>
                                    <button role="tab" aria-controls="settings_Author">Author</button>
                                </menu>
                                <article role="tabpanel" id="settings_theme">
                                    <fieldset>
                                        <legend style="float:none;width:auto;font-size:inherit;">各種設定</legend>
                                        <p>テーマ
                                            <select id="settings_theme_form">
                                                <option>7</option>
                                                <option>XP</option>
                                                <option>98</option>
                                            </select>
                                        </p>
                                        <p>壁紙
                                            <select id="settings_theme_form_wallpaper" style="max-width:100%;">
                                                <option value="なし">なし</option>
                                            </select>
                                        <div id="wallpaperInfo"></div>
                                        </p>
                                    </fieldset>
                                    <div role="progressbar" id="settings_theme_progressbar" class="marquee d-none">
                                    </div>
                                    <script>
                                        // テーマ切替
                                        document.getElementById("settings_theme_form").addEventListener('change', function () {
                                            let pgbar = document.getElementById("settings_theme_progressbar");
                                            pgbar.classList.remove("d-none");
                                            let css;
                                            switch (this.value) {
                                                case "7":
                                                    css = "https://unpkg.com/7.css";
                                                    break;
                                                case "XP":
                                                    css = "https://unpkg.com/xp.css";
                                                    break;
                                                case "98":
                                                    css = "https://unpkg.com/98.css";
                                                    break;
                                            }
                                            setTimeout(function () {
                                                document.getElementById("themeCSS").href = css;
                                                pgbar.classList.add("d-none");
                                            }, 1500);
                                        });

                                        // 壁紙切替
                                        getXML("https://code4fukui.github.io/find47/find47images.csv", function (r) {
                                            let json = CSV2json(r);
                                            console.log(CSV2array(r, ","));
                                            // console.log(json[0]);
                                            let DD = document.getElementById("settings_theme_form_wallpaper");
                                            for (let i = 0; i < json.length; i++) {
                                                let opt = document.createElement("option");
                                                opt.innerText = json[i].title + "(" + json[i].pref + ")";
                                                opt.value = i;
                                                DD.appendChild(opt);
                                            }

                                            document.getElementById("settings_theme_form_wallpaper").addEventListener('change',
                                                function () {
                                                    if (this.value == "なし") {
                                                        document.body.background = "none";
                                                        document.getElementById("wallpaperInfo").innerHTML = "";
                                                        return;
                                                    }
                                                    let data = json[this.value];
                                                    console.log(this.value);
                                                    console.log(data);
                                                    document.body.background = data.url_image;
                                                    document.getElementById("wallpaperInfo").innerHTML = "Data Source:" + "<br/>" +
                                                        "<a href='" + data.url + "' target='_blank'>" +
                                                        data.title + " ／ " + data.pref + "</a><br/>" +
                                                        (data.authoerurl == undefined ? data.author :
                                                        "<a href='" + data.authoerurl + "' target='_blank'>" +
                                                        data.author + "</a>");
                                                });
                                        });
                                    </script>
                                    <p class="d-none">※本設定にはCookieを使用する予定です。</p>
                                </article>
                                <article role="tabpanel" hidden id="settings_Author">
                                    修正依頼、機能要望はこちらまで。<br />
                                    <button onclick="window.open('https://github.com/Zacky0922/KG')"><i
                                            class="fab fa-github"></i> Source on
                                        GitHub</button>
                                </article>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
</body>

</html>