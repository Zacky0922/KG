<!DOCTYPE html>
<!--HTML5-->
<html lang="ja">

<head>
    <!-- meta設定 -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="Content-Script-Type" content="text/javascript" charset="UTF-8" />
    <meta http-equiv="Content-Style-Type" content="text/ccs" charset="UTF-8" />
    <meta name="robots" content="noindex,nofollow" />

    <!-- Global site tag (gtag.js) - Google Analytics by Zacky -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163335381-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-163335381-1');
    </script>

    <!-- PWA設定 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- jQuery/UI -->
    <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
    <!-- jQuery依存 -->

    <!-- Bootstrap 5.0.0 alpha -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
    <!-- ScrollHint -->
    <link rel="stylesheet" href="https://unpkg.com/scroll-hint@latest/css/scroll-hint.css">
    <script src="https://unpkg.com/scroll-hint@latest/js/scroll-hint.min.js"></script>

    <!-- style -->
    <link href="./app_src/style.css" rel="stylesheet">

    <title>KG Dashboard</title>
</head>

<body>

    <div class="tab-content main" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">home
            <!-- スクールバス -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header"><span class="material-icons">
                            departure_board
                        </span>School Bus</div>
                    <div class="card-body">
                        <div class="card-text">
                            <div class="container text-center">
                                <div id="busTime" class="row">
                                    <div class="spinner-border text-secondary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <table id="schoolBusTbl"></table>
                            <hr>
                            <small class="text-muted">2月から（本来の学校サイト上の）スクールバス時刻表データ更新方法を変更したため、こちらでも引用できるようになりました。
                                IEや古いスマホなど、特定の環境で閲覧できない場合や、何かお困り・お気付きの際はご連絡ください。</small>
                        </div>

                    </div>
                    <div class="card-footer">
                        <small class="text-muted">
                            <a href="https://jsh.kgef.ac.jp/schoolbus/">運行予定表</a>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="pills-coronavirus" role="tabpanel" aria-labelledby="pills-coronavirus-tab">
            coronavirus</div>
        <div class="tab-pane fade" id="pills-links" role="tabpanel" aria-labelledby="pills-links-tab">Links</div>
        <div class="tab-pane fade" id="pills-settings" role="tabpanel" aria-labelledby="pills-settings-tab">settings
        </div>
        <div class="tab-pane fade" id="pills-test" role="tabpanel" aria-labelledby="pills-test-tab">test
            <div class="d-none d-sm-block">sm</div>
            <div class="d-none d-md-block">md</div>
            <div class="d-none d-lg-block">lg</div>
            <div class="d-none d-xl-block">xl</div>
            <div class="d-none d-xxl-block">xxl</div>

        </div>
    </div>


    <nav class="navbar fixed-bottom navbar-dark bg-dark">
        <ul class="nav nav-pills container-fluid d-flex" id="pills-tab" role="tablist">
            <li class="nav-item flex-fill" role="presentation">
                <a class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" href="#pills-home" role="tab"
                    aria-controls="pills-home" aria-selected="true">
                    <span class="material-icons">home</span>
                    <span class="d-none d-sm-block d-md-inline">HOME</span>
                </a>
            </li>
            <li class="nav-item flex-fill" role="presentation">
                <a class="nav-link" id="pills-coronavirus-tab" data-bs-toggle="pill" href="#pills-coronavirus"
                    role="tab" aria-controls="pills-coronavirus" aria-selected="false">
                    <span class="material-icons">coronavirus</span>
                    <span class="d-none d-sm-block d-md-inline">健康観察</span>
                </a>
            </li>
            <li class="nav-item flex-fill" role="presentation">
                <a class="nav-link" id="pills-links-tab" data-bs-toggle="pill" href="#pills-links" role="tab"
                    aria-controls="pills-links" aria-selected="false">
                    <span class="material-icons">link</span>
                    <span class="d-none d-sm-block d-md-inline">Links</span>
                </a>
            </li>
            <li class="nav-item flex-fill" role="presentation">
                <a class="nav-link" id="pills-settings-tab" data-bs-toggle="pill" href="#pills-settings" role="tab"
                    aria-controls="pills-settings" aria-selected="false">
                    <span class="material-icons">settings</span>
                    <span class="d-none d-sm-block d-md-inline">設定</span>
                </a>
            </li>
            <li class="nav-item flex-fill d-none" role="presentation">
                <a class="nav-link" id="pills-test-tab" data-bs-toggle="pill" href="#pills-test" role="tab"
                    aria-controls="pills-test" aria-selected="false">
                    <span class="d-none d-sm-block d-md-inline">test</span></a>
            </li>
        </ul>
    </nav>

    <script>
        function setBusRow(tbody, th_tx, td_tx = null) {
            let tr0 = document.createElement("tr");
            let th = document.createElement("th");
            th.innerText = th_tx;
            tr0.appendChild(th);
            tbody.appendChild(tr0);
            if (td_tx != null) {
                let tr1 = document.createElement("tr");
                let td = document.createElement("td");
                td.innerText = td_tx;
                tr1.appendChild(td);
                tbody.appendChild(tr1);
            }
        }
        function setBusTime(json, m = null, d = null) {
            if (m == null || d == null) {
                let today = new Date();
                m = today.getMonth() + 1;
                d = today.getDate();
            }
            let ele = document.getElementById("busTime");
            ele.innerHTML = "";
            // 該当日の行を検索
            let i = 0;
            for (; i < json.length; i++) {
                if (json[i].month == m &&
                    json[i].day == d) {
                    break;
                }
            }
            let tx = [
                m + "月" + d + "日(" + json[i].yobi + ")",
                json[i].remark,
                json[0].ageo0,
                json[i].ageo0,
                json[0].ageo1,
                json[i].ageo1,
                json[0].hasuda0,
                json[i].hasuda0,
                json[0].hasuda1,
                json[i].hasuda1,
            ];
            for (let i = 0; i < tx.length; i++) {
                if (tx[i] == "") { continue }
                let div = document.createElement("div");
                switch (i) {
                    case 0:
                    case 1:
                        div.classList.add("col-12");
                        break;
                    default:
                        div.classList.add("col-6");
                }
                div.innerText = tx[i];
                ele.appendChild(div);
            }
        }
        window.addEventListener("load", function () {

            $.ajax({
                "type": "GET", "async": false,
                "url": "https://script.google.com/macros/s/AKfycbygYn92oqaOVmzjdtv9Tug4jGebaOq9oYW6mKIM2Foiasqbd_hTJdVnuw/exec"
                // exec or dev
            }).then(
                // 通信success
                data => {
                    console.log("Ajax通信success");
                    console.log(data);
                    let timeTbl = data.time;
                    // let passTbl = data.pass;
                    // 時刻表処理
                    setBusTime(data.time);


                    let tbl = document.getElementById("schoolBusTbl");
                    tbl.innerHTML = ""; // 初期化
                    let tbody = document.createElement("tbody");
                    // 今日の日付行取得
                    let d = 0;
                    let today = new Date();
                    for (; d < timeTbl.length; d++) {
                        if (timeTbl[d].month == (today.getMonth() + 1) &&
                            timeTbl[d].day == today.getDate()) {
                            setBusRow(tbody, timeTbl[d].month + "月" + timeTbl[d].day + "日(" + timeTbl[d].yobi + ")", timeTbl[d].remark);
                            setBusRow(tbody, timeTbl[0].ageo0, timeTbl[d].ageo0);
                            setBusRow(tbody, timeTbl[0].hasuda0, timeTbl[d].hasuda0);
                            setBusRow(tbody, timeTbl[0].ageo1, timeTbl[d].ageo1);
                            setBusRow(tbody, timeTbl[0].hasuda1, timeTbl[d].hasuda1);
                            break;
                        }
                    }
                    tbl.appendChild(tbody);
                },
                // 通信error
                error => {
                    console.log("Ajax通信error");
                    console.log(error);
                }
            );
        });
    </script>

</body>

</html>